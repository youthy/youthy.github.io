<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ranch笔记 | Youthy的伟大航路</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="任何使用ranch的程序第一步需要启动ranch_app start ranch application入口ranch_app:123start(_, _) -&gt;	_ &#x3D; consider_profiling(), %% 是否启动eprof	ranch_sup:start_link().">
<meta property="og:type" content="article">
<meta property="og:title" content="ranch笔记">
<meta property="og:url" content="https://youthy.github.io/2015/09/28/ranch%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Youthy的伟大航路">
<meta property="og:description" content="任何使用ranch的程序第一步需要启动ranch_app start ranch application入口ranch_app:123start(_, _) -&gt;	_ &#x3D; consider_profiling(), %% 是否启动eprof	ranch_sup:start_link().">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://youthy.github.io/img/ranch_1.png">
<meta property="og:image" content="https://youthy.github.io/img/ranch_2.png">
<meta property="og:image" content="https://youthy.github.io/img/ranch_3.png">
<meta property="article:published_time" content="2015-09-28T03:58:51.000Z">
<meta property="article:modified_time" content="2018-06-26T09:49:27.736Z">
<meta property="article:author" content="youthy">
<meta property="article:tag" content="erlang">
<meta property="article:tag" content="ranch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://youthy.github.io/img/ranch_1.png">
  
    <link rel="alternative" href="/atom.xml" title="Youthy的伟大航路" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/chizuoqian.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">undefined</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/erlang">erlang</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="weibo" target="_blank" href="https://weibo.com/1592381215" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/erlang/" style="font-size: 20px;">erlang</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 13.33px;">github</a> <a href="/tags/hexo/" style="font-size: 13.33px;">hexo</a> <a href="/tags/linux/" style="font-size: 13.33px;">linux</a> <a href="/tags/makefile/" style="font-size: 10px;">makefile</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/ranch/" style="font-size: 10px;">ranch</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/vim/" style="font-size: 16.67px;">vim</a> <a href="/tags/xmodmap%EF%BC%8Cvim/" style="font-size: 10px;">xmodmap，vim</a> <a href="/tags/%E4%BA%8C%E6%AC%A1%E5%85%83/" style="font-size: 10px;">二次元</a> <a href="/tags/%E4%BB%A3%E7%A0%81/" style="font-size: 10px;">代码</a> <a href="/tags/%E6%83%85%E6%84%9F/" style="font-size: 10px;">情感</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 10px;">教程</a> <a href="/tags/%E6%9D%82%E8%AE%B0/" style="font-size: 10px;">杂记</a> <a href="/tags/%E7%94%B5%E5%BD%B1/" style="font-size: 10px;">电影</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://suexcxine.github.io/">铎哥的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://www.neozone.me">秋歌的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://blog.evercoding.net">Ever</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">梦想做单机游戏。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">undefined</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/chizuoqian.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">undefined</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/erlang">erlang</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="weibo" target="_blank" href="https://weibo.com/1592381215" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-ranch笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/09/28/ranch%E7%AC%94%E8%AE%B0/" class="article-date">
  	<time datetime="2015-09-28T03:58:51.000Z" itemprop="datePublished">9月 28 2015</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ranch笔记
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/erlang/" rel="tag">erlang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ranch/" rel="tag">ranch</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>任何使用ranch的程序第一步需要启动ranch_app</p>
<h2 id="start_ranch_application">start ranch application</h2><p>入口<br><code>ranch_app:</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start(_, _) -&gt;</span><br><span class="line">	_ = consider_profiling(), %% 是否启动eprof</span><br><span class="line">	ranch_sup:start_link().</span><br></pre></td></tr></table></figure></p>
<span id="more"></span>
<p><code>ranch_sup:</code><br>整个应用的最顶级sup， 它建立ranch_server ets,并启动ranch_server这个gen_server,将ranch_server这个ets归属于ranch_sup提高容错.防止数据丢失。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">start_link() -&gt;</span><br><span class="line">	supervisor:start_link(&#123;local, ?MODULE&#125;, ?MODULE, []).</span><br><span class="line"></span><br><span class="line">init([]) -&gt;</span><br><span class="line">	ranch_server = ets:new(ranch_server, [</span><br><span class="line">		ordered_set, public, named_table]),</span><br><span class="line">	Procs = [</span><br><span class="line">		&#123;ranch_server, &#123;ranch_server, start_link, []&#125;,</span><br><span class="line">			permanent, 5000, worker, [ranch_server]&#125;</span><br><span class="line">	],</span><br><span class="line">	&#123;ok, &#123;&#123;one_for_one, 10, 10&#125;, Procs&#125;&#125;.</span><br></pre></td></tr></table></figure></p>
<p><code>ranch_server:</code><br>是一个gen_server,init中从ranch_server ets中恢复数据<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">init([]) -&gt;</span><br><span class="line">	Monitors = [&#123;&#123;erlang:monitor(process, Pid), Pid&#125;, Ref&#125; ||</span><br><span class="line">		[Ref, Pid] &lt;- ets:match(?TAB, &#123;&#123;conns_sup, &#x27;$1&#x27;&#125;, &#x27;$2&#x27;&#125;)],</span><br><span class="line">	&#123;ok, #state&#123;monitors=Monitors&#125;&#125;.</span><br></pre></td></tr></table></figure><br><strong>ranch初始化完成</strong></p>
<h2 id=""><img src="/img/ranch_1.png" alt=""></h2><p>至此ranch实际上没有做任何事情，它并没有监听任何端口，需要使用者在自己的app中显示的调用ranch:start_listener来启动acceptor_pool.</p>
<p>在作者的demo中是这样：</p>
<h3 id="tcp_echo_app:">tcp_echo_app:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start(_Type, _Args) -&gt;</span><br><span class="line">	&#123;ok, _&#125; = ranch:start_listener(tcp_echo, 1,</span><br><span class="line">		ranch_tcp, [&#123;port, 5555&#125;], echo_protocol, []),</span><br><span class="line">	tcp_echo_sup:start_link().</span><br></pre></td></tr></table></figure>
<p><code>ranch:start_listner</code>接受6个参数 </p>
<ol>
<li>名字: tcp_echo,</li>
<li>acceptor数量: 1<br><strong>此处不是connection的数量!! wiki说:</strong><blockquote>
<p>First of all, it should not be confused with the maximum number of connections. Acceptor processes are only used for accepting and have nothing else in common with connection processes. Therefore there is nothing to be gained from setting this number too high, in fact it can slow everything else down.</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>Second, this number should be high enough to allow Ranch to accept connections concurrently. But the number of cores available doesn’t seem to be the only factor for choosing this number, as we can observe faster accepts if we have more acceptors than cores. It might be entirely dependent on the protocol, however.</p>
</blockquote>
<p>总之就是太少太多都不好，他们的观测得到100较为合适</p>
<ol start="3">
<li>transport的方式: ranch_tcp</li>
<li>transport options: [{port, 5555}],<br><code>ranch_tcp:</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen(Opts) -&gt;</span><br><span class="line">	Opts2 = ranch:set_option_default(Opts, backlog, 1024),</span><br><span class="line">	Opts3 = ranch:set_option_default(Opts2, nodelay, true),</span><br><span class="line">	Opts4 = ranch:set_option_default(Opts3, send_timeout, 30000),</span><br><span class="line">	Opts5 = ranch:set_option_default(Opts4, send_timeout_close, true),</span><br><span class="line">	gen_tcp:listen(0, ranch:filter_options(Opts5, listen_options(),</span><br><span class="line">		[binary, &#123;active, false&#125;, &#123;packet, raw&#125;, &#123;reuseaddr, true&#125;])).</span><br></pre></td></tr></table></figure>
可以看出ranch_tcp代码中默认使用binary, {active,false}, 等设置，所以无法通过options更改。可以在start_listener之后的通过Transport:setopts/2更改.<br>但是backlog, nodelay等可以通过Opts在start的时候就设置好.<br><strong>port</strong>:未指定的话，则会随意一个端口.还有，不要设置1024以上的。原因如下<blockquote>
<p>Some systems limit access to ports below 1024 for security reasons.The methods for listening on privileged ports vary between systems, please refer to your system’s documentation for more information.</p>
</blockquote>
</li>
</ol>
<p><strong>max_connections</strong>: {max_connections, Number|infinity}Number默认是1024.尽量不要infinity。<br>还可以通过<code>ranch:set_max_connections</code>设置.有时有个别进程是长链接，不希望它计入connections的计数。可以通过<code>ranch:remove_conections/1</code>移除1.</p>
<ol start="5">
<li>protocol_handler mod: echo_protocol</li>
<li>protocol options: []</li>
</ol>
<h3 id="ranch:">ranch:</h3><p>listener的实现:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">start_listener(tcp_echo, 1, ranch_tcp, [&#123;port, 5555&#125;], echo_protocol, []) -&gt;</span><br><span class="line">    ...</span><br><span class="line">	ChildSpec = &#123;&#123;ranch_listener_sup, tcp_echo&#125;, &#123;ranch_listener_sup, start_link, [</span><br><span class="line">		tcp_echo, 1, ranch_tcp, [&#123;port, 5555&#125;], echo_protocol, [] </span><br><span class="line">	]&#125;, permanent, infinity, supervisor, [ranch_listener_sup]&#125;.</span><br><span class="line">	Res = supervisor:start_child(ranch_sup, ChildSpec),</span><br><span class="line">	Socket = proplists:get_value(socket, [&#123;port, 5555&#125;]),</span><br><span class="line">	case Res of</span><br><span class="line">		&#123;ok, Pid&#125; when Socket =/= undefined -&gt;</span><br><span class="line">		    %% 此处更改socket的拥有者,暂不管</span><br><span class="line">		  	Children = supervisor:which_children(Pid),</span><br><span class="line">		  	&#123;_, AcceptorsSup, _, _&#125;</span><br><span class="line">		  		= lists:keyfind(ranch_acceptors_sup, 1, Children),</span><br><span class="line">		   catch Transport:controlling_process(Socket, AcceptorsSup);</span><br><span class="line">		_ -&gt;</span><br><span class="line">			ok</span><br><span class="line">	end,</span><br><span class="line">	Res</span><br><span class="line">	...</span><br></pre></td></tr></table></figure></p>
<p>在未指定socket的情况，start_listener通过<code>supervisor:start_child/2</code>启动了<code>ranch_listener_sup</code></p>
<h3 id="ranch_listener_sup:">ranch_listener_sup:</h3><p>listener_sup 仍然是个supervisor，它得到一个max_connections(默认1024）, 通知ranch_server储存max_connection,和Opts。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">start_link(Ref, NbAcceptors, Transport, TransOpts, Protocol, ProtoOpts) -&gt;</span><br><span class="line">	MaxConns = proplists:get_value(max_connections, TransOpts, 1024),</span><br><span class="line">	ranch_server:set_new_listener_opts(Ref, MaxConns, ProtoOpts),</span><br><span class="line">	%% 注意此处没有注册名字</span><br><span class="line">	supervisor:start_link(?MODULE, &#123;</span><br><span class="line">		Ref, NbAcceptors, Transport, TransOpts, Protocol</span><br><span class="line">	&#125;).</span><br></pre></td></tr></table></figure></p>
<p><code>ranch_server:</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">handle_call(&#123;set_new_listener_opts, Ref, MaxConns, Opts&#125;, _, State) -&gt;</span><br><span class="line">    %% 将数据存入rank_server ets.</span><br><span class="line">	ets:insert(rank_server, &#123;&#123;max_conns, Ref&#125;, MaxConns&#125;),</span><br><span class="line">	ets:insert(rank_server, &#123;&#123;opts, Ref&#125;, Opts&#125;),</span><br><span class="line">	&#123;reply, ok, State&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>ranch_listener_sup:</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">init(&#123;tcp_echo, 1, ranch_tcp, [&#123;port, 5555&#125;], echo_protocol&#125;) -&gt;</span><br><span class="line">	AckTimeout = proplists:get_value(ack_timeout, TransOpts, 5000),</span><br><span class="line">	ConnType = proplists:get_value(connection_type, TransOpts, worker),</span><br><span class="line">	Shutdown = proplists:get_value(shutdown, TransOpts, 5000),</span><br><span class="line">	ChildSpecs = [</span><br><span class="line">		&#123;ranch_conns_sup, &#123;ranch_conns_sup, start_link,</span><br><span class="line">				[Ref, ConnType, Shutdown, Transport, AckTimeout, Protocol]&#125;,</span><br><span class="line">			permanent, infinity, supervisor, [ranch_conns_sup]&#125;,</span><br><span class="line">		&#123;ranch_acceptors_sup, &#123;ranch_acceptors_sup, start_link,</span><br><span class="line">				[Ref, NbAcceptors, Transport, TransOpts]&#125;,</span><br><span class="line">			permanent, infinity, supervisor, [ranch_acceptors_sup]&#125;</span><br><span class="line">	],</span><br><span class="line">	&#123;ok, &#123;&#123;rest_for_one, 10, 10&#125;, ChildSpecs&#125;&#125;.</span><br></pre></td></tr></table></figure></p>
<p>listener_sup 启动 conns_sup和acceptors_sup,这两个都是supervisor 所以shutdown都设置成infinity<br>但是其中conns_sup是个自定义的supervisor，作者解释是为了优化create和accept connection。</p>
<blockquote>
<p>Ranch uses a custom supervisor for managing connections. This supervisor keeps track of the number of connections and handles connection limits directly. While it is heavily optimized to perform the task of creating connection processes for accepted connections, it is still following the OTP principles and the usual sys and supervisor calls will work on it as expected.</p>
</blockquote>
<h3 id="Ranch_conns_sup:">Ranch_conns_sup:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">start_link(Ref, ConnType, Shutdown, Transport, AckTimeout, Protocol) -&gt;</span><br><span class="line">	proc_lib:start_link(?MODULE, init,</span><br><span class="line">	[self(), Ref, ConnType, Shutdown, Transport, AckTimeout, Protocol]).</span><br><span class="line">	</span><br><span class="line">init(Parent, Ref, ConnType, Shutdown, Transport, AckTimeout, Protocol) -&gt;</span><br><span class="line">	process_flag(trap_exit, true),</span><br><span class="line">	ok = ranch_server:set_connections_sup(Ref, self()),</span><br><span class="line">	MaxConns = ranch_server:get_max_connections(Ref),</span><br><span class="line">	Opts = ranch_server:get_protocol_options(Ref),</span><br><span class="line">	ok = proc_lib:init_ack(Parent, &#123;ok, self()&#125;),</span><br><span class="line">	loop(#state&#123;parent=Parent, ref=Ref, conn_type=ConnType,</span><br><span class="line">		shutdown=Shutdown, transport=Transport, protocol=Protocol,</span><br><span class="line">		opts=Opts, ack_timeout=AckTimeout, max_conns=MaxConns&#125;, 0, 0, []).</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">14&gt; rp(sys:get_status(ConnsSup)).</span><br><span class="line">&#123;status,&lt;0.43.0&gt;,</span><br><span class="line">        &#123;module,ranch_conns_sup&#125;,</span><br><span class="line">        [[&#123;&#x27;$ancestors&#x27;,[&lt;0.42.0&gt;,ranch_sup,&lt;0.34.0&gt;]&#125;,</span><br><span class="line">          &#123;&#x27;$initial_call&#x27;,&#123;ranch_conns_sup,init,7&#125;&#125;],</span><br><span class="line">         running,&lt;0.42.0&gt;,[],</span><br><span class="line">         &#123;&#123;state,&lt;0.42.0&gt;,tcp_echo,worker,5000,ranch_tcp,</span><br><span class="line">                 echo_protocol,[],5000,1024&#125;,</span><br><span class="line">          0,0,[]&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>上面使用<code>sys:get_status(Name|Pid)</code>得到ranch_conns_sup的#state{}。</p>
<h3 id="Ranch_acceptor_sup:">Ranch_acceptor_sup:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">start_link(Ref, NbAcceptors, Transport, TransOpts) -&gt;</span><br><span class="line">	supervisor:start_link(?MODULE, [Ref, NbAcceptors, Transport, TransOpts]).</span><br><span class="line"></span><br><span class="line">init([Ref, NbAcceptors, Transport, TransOpts]) -&gt;</span><br><span class="line">	ConnsSup = ranch_server:get_connections_sup(Ref),</span><br><span class="line">	LSocket = case proplists:get_value(socket, TransOpts) of</span><br><span class="line">		undefined -&gt;</span><br><span class="line">			TransOpts2 = proplists:delete(ack_timeout,</span><br><span class="line">				proplists:delete(connection_type,</span><br><span class="line">				proplists:delete(max_connections,</span><br><span class="line">				proplists:delete(shutdown,</span><br><span class="line">				proplists:delete(socket, TransOpts))))),</span><br><span class="line">			case Transport:listen(TransOpts2) of</span><br><span class="line">				&#123;ok, Socket&#125; -&gt; Socket;</span><br><span class="line">				&#123;error, Reason&#125; -&gt; listen_error(Ref, Transport, TransOpts2, Reason)</span><br><span class="line">			end;</span><br><span class="line">		Socket -&gt;</span><br><span class="line">			Socket</span><br><span class="line">	end,</span><br><span class="line">	&#123;ok, Addr&#125; = Transport:sockname(LSocket),</span><br><span class="line">	ranch_server:set_addr(Ref, Addr),</span><br><span class="line">	Procs = [</span><br><span class="line">		&#123;&#123;acceptor, self(), N&#125;, &#123;ranch_acceptor, start_link, [</span><br><span class="line">			LSocket, Transport, ConnsSup</span><br><span class="line">		]&#125;, permanent, brutal_kill, worker, []&#125;</span><br><span class="line">			|| N &lt;- lists:seq(1, NbAcceptors)],</span><br><span class="line">	&#123;ok, &#123;&#123;one_for_one, 10, 10&#125;, Procs&#125;&#125;.</span><br></pre></td></tr></table></figure>
<p>acceptor_sup完成了得到一个ListenSocket, 然后启动N个acceptor进程，这些acceptor的loop等待<code>gen_tcp:accept</code> | <code>ssl:transport_accept</code><br><code>Transport:listen</code>的本质就是<code>gen_tcp:listen</code>或者<code>ssl:listen</code> 它返回一个ListenSocket<br><code>Transport:sockname</code> :: <code>inet:sockname</code> | <code>ssl:sockname</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">13&gt; sys:get_status(AccepterSup).</span><br><span class="line">&#123;status,&lt;0.44.0&gt;,</span><br><span class="line">        &#123;module,gen_server&#125;,</span><br><span class="line">        [[&#123;&#x27;$ancestors&#x27;,[&lt;0.42.0&gt;,ranch_sup,&lt;0.34.0&gt;]&#125;,</span><br><span class="line">          &#123;&#x27;$initial_call&#x27;,&#123;supervisor,ranch_acceptors_sup,1&#125;&#125;],</span><br><span class="line">         running,&lt;0.42.0&gt;,[],</span><br><span class="line">         [&#123;header,&quot;Status for generic server &lt;0.44.0&gt;&quot;&#125;,</span><br><span class="line">          &#123;data,[&#123;&quot;Status&quot;,running&#125;,</span><br><span class="line">                 &#123;&quot;Parent&quot;,&lt;0.42.0&gt;&#125;,</span><br><span class="line">                 &#123;&quot;Logged events&quot;,[]&#125;]&#125;,</span><br><span class="line">          &#123;data,[&#123;&quot;State&quot;,</span><br><span class="line">                  &#123;state,&#123;&lt;0.44.0&gt;,ranch_acceptors_sup&#125;,</span><br><span class="line">                         one_for_one,</span><br><span class="line">                         [&#123;child,&lt;0.45.0&gt;,</span><br><span class="line">                                 &#123;acceptor,&lt;0.44.0&gt;,1&#125;,</span><br><span class="line">                                 &#123;ranch_acceptor,start_link,</span><br><span class="line">                                                 [#Port&lt;0.917&gt;,ranch_tcp,&lt;0.43.0&gt;]&#125;,</span><br><span class="line">                                 permanent,brutal_kill,worker,[]&#125;],</span><br><span class="line">                         undefined,10,10,[],ranch_acceptors_sup,</span><br><span class="line">                         [tcp_echo,1,ranch_tcp,[&#123;port,5555&#125;]]&#125;&#125;]&#125;]]&#125;</span><br></pre></td></tr></table></figure></p>
<p>demo中只启动了一个acceptor<br>至此完了了所有进程的启动。等待connection进来。<br><img src="/img/ranch_2.png" alt=""></p>
<h3 id="Acceptor:">Acceptor:</h3><p>acceptor的作用是<code>accept(ListenSocket) -&gt; Socket.</code> 通过<code>Transport:controlling_process</code>,将端口控制交给<code>conns_sup</code>, 然后向conns_sup发送<code>&#123;ranch_conns_sup, start_protocol, AcceptorPid, Socket&#125;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">start_link(LSocket, Transport, ConnsSup) -&gt;</span><br><span class="line">	Pid = spawn_link(?MODULE, loop, [LSocket, Transport, ConnsSup]),</span><br><span class="line">	&#123;ok, Pid&#125;.</span><br><span class="line"></span><br><span class="line">-spec loop(inet:socket(), module(), pid()) -&gt; no_return().</span><br><span class="line">loop(LSocket, Transport, ConnsSup) -&gt;</span><br><span class="line">	_ = case Transport:accept(LSocket, infinity) of</span><br><span class="line">		&#123;ok, CSocket&#125; -&gt;</span><br><span class="line">			case Transport:controlling_process(CSocket, ConnsSup) of</span><br><span class="line">				ok -&gt;</span><br><span class="line">					ranch_conns_sup:start_protocol(ConnsSup, CSocket);</span><br><span class="line">				&#123;error, _&#125; -&gt;</span><br><span class="line">					Transport:close(CSocket)</span><br><span class="line">			end;</span><br><span class="line">		&#123;error, emfile&#125; -&gt;</span><br><span class="line">			receive after 100 -&gt; ok end;</span><br><span class="line">		&#123;error, Reason&#125; when Reason =/= closed -&gt;</span><br><span class="line">			ok</span><br><span class="line">	end,</span><br><span class="line">	flush(),</span><br><span class="line">	?MODULE:loop(LSocket, Transport, ConnsSup).</span><br></pre></td></tr></table></figure>
<p><code>ranch_conns_sup</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start_protocol(SupPid, Socket) -&gt;</span><br><span class="line">	SupPid ! &#123;?MODULE, start_protocol, self(), Socket&#125;,</span><br><span class="line">	receive SupPid -&gt; ok end.</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;?MODULE, start_protocol, To, Socket&#125; -&gt;</span><br><span class="line">	try Protocol:start_link(Ref, Socket, Transport, Opts) of</span><br><span class="line">		&#123;ok, Pid&#125; -&gt;</span><br><span class="line">			shoot(State, CurConns, NbChildren, Sleepers, To, Socket, Pid, Pid);</span><br><span class="line">		&#123;ok, SupPid, ProtocolPid&#125; when ConnType =:= supervisor -&gt;</span><br><span class="line">			shoot(State, CurConns, NbChildren, Sleepers, To, Socket, SupPid, ProtocolPid);</span><br><span class="line">		Ret -&gt;</span><br><span class="line">			To ! self(),</span><br><span class="line">			error_logger:error_msg(</span><br><span class="line">				&quot;Ranch listener ~p connection process start failure; &quot;</span><br><span class="line">				&quot;~p:start_link/4 returned: ~999999p~n&quot;,</span><br><span class="line">				[Ref, Protocol, Ret]),</span><br><span class="line">			Transport:close(Socket),</span><br><span class="line">			loop(State, CurConns, NbChildren, Sleepers)</span><br><span class="line">			......</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">shoot(State=#state&#123;ref=Ref, transport=Transport, ack_timeout=AckTimeout, max_conns=MaxConns&#125;,</span><br><span class="line">		CurConns, NbChildren, Sleepers, To, Socket, SupPid, ProtocolPid) -&gt;</span><br><span class="line">	case Transport:controlling_process(Socket, ProtocolPid) of</span><br><span class="line">		ok -&gt;</span><br><span class="line">		    %% 通知echo_protocol进程控制权已转移。</span><br><span class="line">			ProtocolPid ! &#123;shoot, Ref, Transport, Socket, AckTimeout&#125;,</span><br><span class="line">			put(SupPid, true),</span><br><span class="line">			CurConns2 = CurConns + 1,</span><br><span class="line">			if CurConns2 &lt; MaxConns -&gt;</span><br><span class="line">					To ! self(),</span><br><span class="line">					loop(State, CurConns2, NbChildren + 1, Sleepers);</span><br><span class="line">				true -&gt;</span><br><span class="line">					loop(State, CurConns2, NbChildren + 1, [To|Sleepers])</span><br><span class="line">			end;</span><br><span class="line">		&#123;error, _&#125; -&gt;</span><br><span class="line">			Transport:close(Socket),</span><br><span class="line">			%% Only kill the supervised pid, because the connection&#x27;s pid,</span><br><span class="line">			%% when different, is supposed to be sitting under it and linked.</span><br><span class="line">			exit(SupPid, kill),</span><br><span class="line">			loop(State, CurConns, NbChildren, Sleepers)</span><br><span class="line">	end.</span><br></pre></td></tr></table></figure>
<h3 id="ranch_protocol:">ranch_protocol:</h3><p>conns_sup在完成<code>controlling_process</code>后要通知protocol进程完成了转移。因为此时protocol的init还没有执行结束，一直在等着控制权转移。因为控制权没转移是不能进入loop的.spawn_link及时将自己的pid告诉了conns_sup.如果是gen_server等需要init结束才返回的进程需要特殊处理, 在下面分析.同时完成转移后conns_sup还给acceptor发送一条自己的pid，告诉acceptor转移完成。因为这之前acceptor一直处在receive状态，等待conns_sup完成工作。不完成他不会再次参与accept操作.<br><code>echo_protocol:</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">start_link(Ref, Socket, Transport, Opts) -&gt;</span><br><span class="line">	Pid = spawn_link(?MODULE, init, [Ref, Socket, Transport, Opts]),</span><br><span class="line">	&#123;ok, Pid&#125;.</span><br><span class="line"></span><br><span class="line">init(Ref, Socket, Transport, _Opts = []) -&gt;</span><br><span class="line">  %% 必须调用 accept_ack，确保socket控制权</span><br><span class="line">	ok = ranch:accept_ack(Ref),</span><br><span class="line">	loop(Socket, Transport).</span><br></pre></td></tr></table></figure></p>
<p><code>ranch:</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">accept_ack(Ref) -&gt;</span><br><span class="line">	receive &#123;shoot, Ref, Transport, Socket, AckTimeout&#125; -&gt;</span><br><span class="line">		Transport:accept_ack(Socket, AckTimeout)</span><br><span class="line">	end.</span><br></pre></td></tr></table></figure></p>
<p>链接套接字的逻辑进程都要有</p>
<ol>
<li>-behavior(ranch_protocol). 定义了一个start_link/4 callback而已。</li>
<li>在任何对端口的操作之前一定要确保执行过ranch:accept_ack(Ref)(确保端口控制权交给自己).在此之后可以运行ranch_tcp|ranch_ssl:setopts(Opt)完成自定义对端口的设置<br>如果同时他是个gen_server,gen_fsm等有自己的start_link, 会产生一个问题，因为init中放入ranch:accept_ack/1会形成死锁。(见上面，即<code>conns_sup</code> 在等待<code>ranch_protocol</code>进程的pid返回。而<code>ranch_protocol</code>在等待<code>conns_sup</code>将端口控制交给自己)见问题说明<br><a target="_blank" rel="noopener" href="https://github.com/ninenines/ranch/blob/master/doc/src/guide/protocols.asciidoc">ranch_protocol_doc</a>.<br>作者再上面给出了两种解决办法:</li>
<li>在start_link 中用proc_lib:start_link代替gen_server:start_link,然后在init中主动调用proc_lib：init_ack通知父进程初始化完毕，然后调用ranch:accept_ack，再之后手动用gen_server:enter_loop进入循环。在之前这里分析过gen_server的初始化过程。<br><a href="/2015/07/31/erlang-question-gen-server-and-init/">gen_server和init</a></li>
<li>作者在init中返回timeout为0，然后通过handle_info(timeout...)调用ranch:accept_ack。实际上最好不要这么用，原因还是见上面的文章。具体剖析过为什么不能这么用。还是用 self()!timeout替代这种方法吧。<br><img src="/img/ranch_3.png" alt=""></li>
</ol>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/09/29/makefile%E7%AC%94%E8%AE%B0/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          makefile笔记
        
      </div>
    </a>
  
  
    <a href="/2015/09/19/gitnote/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">gitnote</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="ranch笔记" data-title="ranch笔记" data-url="https://youthy.github.io/2015/09/28/ranch%E7%AC%94%E8%AE%B0/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2021 youthy
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>


<script src="/js/main.js"></script>







<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>