<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>erlang_mysql_driver　源码分析(二) | Youthy的伟大航路</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="#mysql_conn:start回到mysql:start_link这个最开始这个地方 1234LogFun1 &#x3D; if LogFun &#x3D;&#x3D; undefined -&gt; fun log&#x2F;4; true -&gt; LogFun end,   case mysql_conn:start(Host, Port, User, Password, Database, LogFun1,		  Enco">
<meta property="og:type" content="article">
<meta property="og:title" content="erlang_mysql_driver　源码分析(二)">
<meta property="og:url" content="http://youthy.github.io/2015/06/09/erlang_mysql_driver%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%8C)/index.html">
<meta property="og:site_name" content="Youthy的伟大航路">
<meta property="og:description" content="#mysql_conn:start回到mysql:start_link这个最开始这个地方 1234LogFun1 &#x3D; if LogFun &#x3D;&#x3D; undefined -&gt; fun log&#x2F;4; true -&gt; LogFun end,   case mysql_conn:start(Host, Port, User, Password, Database, LogFun1,		  Enco">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2015-06-09T09:21:15.000Z">
<meta property="article:modified_time" content="2018-06-26T09:49:27.734Z">
<meta property="article:author" content="youthy">
<meta property="article:tag" content="erlang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Youthy的伟大航路" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/chizuoqian.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">undefined</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/erlang">erlang</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="weibo" target="_blank" href="http://weibo.com/1592381215" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/erlang/" style="font-size: 20px;">erlang</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 13.33px;">github</a> <a href="/tags/hexo/" style="font-size: 13.33px;">hexo</a> <a href="/tags/linux/" style="font-size: 13.33px;">linux</a> <a href="/tags/makefile/" style="font-size: 10px;">makefile</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/ranch/" style="font-size: 10px;">ranch</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/vim/" style="font-size: 16.67px;">vim</a> <a href="/tags/xmodmap%EF%BC%8Cvim/" style="font-size: 10px;">xmodmap，vim</a> <a href="/tags/%E4%BA%8C%E6%AC%A1%E5%85%83/" style="font-size: 10px;">二次元</a> <a href="/tags/%E4%BB%A3%E7%A0%81/" style="font-size: 10px;">代码</a> <a href="/tags/%E6%83%85%E6%84%9F/" style="font-size: 10px;">情感</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 10px;">教程</a> <a href="/tags/%E6%9D%82%E8%AE%B0/" style="font-size: 10px;">杂记</a> <a href="/tags/%E7%94%B5%E5%BD%B1/" style="font-size: 10px;">电影</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://suexcxine.github.io/">铎哥的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.neozone.me">秋歌的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.evercoding.net">Ever</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">梦想做单机游戏。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">undefined</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/chizuoqian.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">undefined</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/erlang">erlang</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="weibo" target="_blank" href="http://weibo.com/1592381215" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-erlang_mysql_driver源码分析(二)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/09/erlang_mysql_driver%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%8C)/" class="article-date">
  	<time datetime="2015-06-09T09:21:15.000Z" itemprop="datePublished">6月 9 2015</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      erlang_mysql_driver　源码分析(二)
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/erlang/" rel="tag">erlang</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/erlang/">erlang</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#mysql_conn:start<br>回到mysql:start_link这个最开始这个地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LogFun1 = if LogFun == undefined -&gt; fun log/4; true -&gt; LogFun end,</span><br><span class="line">   case mysql_conn:start(Host, Port, User, Password, Database, LogFun1,</span><br><span class="line">		  Encoding, PoolId) of</span><br><span class="line">&#123;ok, ConnPid&#125; -&gt;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>起初为了不断开gen_server的创建，我们没有进入mysql_conn里面。现在可以进去一窥究竟啦。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">start(Host, Port, User, Password, Database, LogFun, Encoding, PoolId) -&gt;</span><br><span class="line">    ConnPid = self(),</span><br><span class="line">    Pid = spawn(fun () -&gt;</span><br><span class="line">			init(Host, Port, User, Password, Database,</span><br><span class="line">			     LogFun, Encoding, PoolId, ConnPid)</span><br><span class="line">		end),</span><br><span class="line">    post_start(Pid, LogFun).</span><br><span class="line">    --------------------</span><br><span class="line">post_start(Pid, LogFun) -&gt;</span><br><span class="line">    receive</span><br><span class="line">	&#123;mysql_conn, Pid, ok&#125; -&gt;</span><br><span class="line">	    &#123;ok, Pid&#125;;</span><br><span class="line">	&#123;mysql_conn, Pid, &#123;error, Reason&#125;&#125; -&gt;</span><br><span class="line">	    &#123;error, Reason&#125;;</span><br><span class="line">	Unknown -&gt;</span><br><span class="line">	    ?Log2(LogFun, error,</span><br><span class="line">		 &quot;received unknown signal, exiting: ~p&quot;, [Unknown]),</span><br><span class="line">	    &#123;error, &quot;unknown signal received&quot;&#125;</span><br><span class="line">    after 5000 -&gt;</span><br><span class="line">	    &#123;error, &quot;timed out&quot;&#125;</span><br><span class="line">    end.</span><br></pre></td></tr></table></figure></p>
<p>这里作者将post_start抽出来了，因为与start类似还有个start_link也需要这块代码，但是值得注意的是<br>post_start里面的receive仍然是由mysql:start_link生成的my_sql_game这个gen_server 在调用，而且<code>ConnPid = self()</code>这句代码很有歧义，因为这个ConnPid与mysql中的<code>&#123;ok, ConnPid&#125;</code>明显不是同一个意思。这里的ConnPid实际就是gen_server的Pid，用来传给init作为父进程参数，在子进程可以给父进程发消息,我觉得把这段post_start放到mysql中更容易理解一点。<br>这里我们可以看出来，start函数spawn一个mysql_conn:init这个进程，然后等待消息，如果成功的话，会返回{ok, Pid}，这个Pid是真正意义的ConnPid，用来生成#conn加入my_sql_game的#state里面的。其他情况会返回{error, Reason}.<br>然后看一下init<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">init(Host, Port, User, Password, Database, LogFun, Encoding, PoolId, Parent) -&gt;</span><br><span class="line">    case mysql_recv:start_link(Host, Port, LogFun, self()) of</span><br><span class="line">	&#123;ok, RecvPid, Sock&#125; -&gt;</span><br><span class="line">	    case mysql_init(Sock, RecvPid, User, Password, LogFun) of</span><br><span class="line">		&#123;ok, Version&#125; -&gt;</span><br><span class="line">		    Db = iolist_to_binary(Database),</span><br><span class="line">		    case do_query(Sock, RecvPid, LogFun,</span><br><span class="line">				  &lt;&lt;&quot;use &quot;, Db/binary&gt;&gt;,</span><br><span class="line">				  Version) of</span><br><span class="line">			&#123;error, MySQLRes&#125; -&gt;</span><br><span class="line">			    ?Log2(LogFun, error,</span><br><span class="line">				 &quot;mysql_conn: Failed changing to database &quot;</span><br><span class="line">				 &quot;~p : ~p&quot;,</span><br><span class="line">				 [Database,</span><br><span class="line">				  mysql:get_result_reason(MySQLRes)]),</span><br><span class="line">			    Parent ! &#123;mysql_conn, self(),</span><br><span class="line">				      &#123;error, failed_changing_database&#125;&#125;;</span><br><span class="line"></span><br><span class="line">			%% ResultType: data | updated</span><br><span class="line">			&#123;_ResultType, _MySQLRes&#125; -&gt;</span><br><span class="line">			    Parent ! &#123;mysql_conn, self(), ok&#125;,</span><br><span class="line">			    case Encoding of</span><br><span class="line">				undefined -&gt; undefined;</span><br><span class="line">				_ -&gt;</span><br><span class="line">				    EncodingBinary = list_to_binary(atom_to_list(Encoding)),</span><br><span class="line">				    do_query(Sock, RecvPid, LogFun,</span><br><span class="line">					     &lt;&lt;&quot;set names &#x27;&quot;, EncodingBinary/binary, &quot;&#x27;&quot;&gt;&gt;,</span><br><span class="line">					     Version)</span><br><span class="line">			    end,</span><br><span class="line">			    State = #state&#123;mysql_version=Version,</span><br><span class="line">					   recv_pid = RecvPid,</span><br><span class="line">					   socket   = Sock,</span><br><span class="line">					   log_fun  = LogFun,</span><br><span class="line">					   pool_id  = PoolId,</span><br><span class="line">					   data     = &lt;&lt;&gt;&gt;</span><br><span class="line">					  &#125;,</span><br><span class="line">			    loop(State)</span><br><span class="line">		    end;</span><br><span class="line">		&#123;error, _Reason&#125; -&gt;</span><br><span class="line">		    Parent ! &#123;mysql_conn, self(), &#123;error, login_failed&#125;&#125;</span><br><span class="line">	    end;</span><br><span class="line">	E -&gt;</span><br><span class="line">	    ?Log2(LogFun, error,</span><br><span class="line">		 &quot;failed connecting to ~p:~p : ~p&quot;,</span><br><span class="line">		 [Host, Port, E]),</span><br><span class="line">	    Parent ! &#123;mysql_conn, self(), &#123;error, connect_failed&#125;&#125;</span><br><span class="line">    end.</span><br></pre></td></tr></table></figure></p>
<p>这个init比较长，而且里面又调了mysql_recv:start_link，之前之所以没有直接分析这里面也是这个原因，在start_link里面重复调用各个模块的start_link很容易绕进去。<br>同样，我们根据case语句，知道mysql_recv:start_link建了一个新的进程，并且返回RecvPid和一个Sock，可知创建进程的同时监听了某个端口。如果没有成功会返回{error， Reason}</p>
<p>之后进入mysql_init函数。我们先不要进入mysql_init，这个函数完成了用户名和密码的认证，认证成功会返回{ok, Version}</p>
<p>接下来要做的是<br><code>case do_query(Sock, RecvPid, LogFun,
                  &lt;&lt;&quot;use &quot;, Db/binary&gt;&gt;,
                  Version) of</code><br>通知端口我们要使用哪个数据库，打印出来是这段文字<br><code>fetch &lt;&lt;&quot;use aries_game&quot;&gt;&gt;</code><br>返回结果{error, MysqlRes}或者{ResultType, MysqlRes}.<br>MysqlRes是一个record</p>
<blockquote>
<p>-record(mysql_result,<br>    {fieldinfo=[],<br>     rows=[],<br>     affectedrows=0,<br>     error=&quot;&quot;}).</p>
</blockquote>
<p>在do_query的里面，将端口返回来的结果构造成#mysql_result的样子，他包含了需要的rows，或者操作所影响的affetedrows，fieldinfo以及如果出错的错误信息error.<br>如果返回{error, MysqlRes}, 我们调用接口mysql:get_result_reason(MysqlRes)获取错误原因。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">get_result_reason(#mysql_result&#123;error=Reason&#125;) -&gt;</span><br><span class="line">    Reason.</span><br></pre></td></tr></table></figure></p>
<p>并通知父进程出错了<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Parent ! &#123;mysql_conn, self(), &#123;error, failed_changing_database&#125;&#125;;</span><br></pre></td></tr></table></figure></p>
<p>相反<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;_ResultType, _MySQLRes&#125; -&gt;</span><br><span class="line">			    Parent ! &#123;mysql_conn, self(), ok&#125;,</span><br></pre></td></tr></table></figure></p>
<p>如果没有出错，我们就告诉父进程ok。<br>还记得post_start里面的<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">post_start(Pid, LogFun) -&gt;</span><br><span class="line">    receive</span><br><span class="line">	&#123;mysql_conn, Pid, ok&#125; -&gt;</span><br><span class="line">	    &#123;ok, Pid&#125;;</span><br><span class="line">	&#123;mysql_conn, Pid, &#123;error, Reason&#125;&#125; -&gt;</span><br><span class="line">	    &#123;error, Reason&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这就是receive我们这些消息的地方。<br>后面的<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EncodingBinary = list_to_binary(atom_to_list(Encoding)),</span><br><span class="line">		    do_query(Sock, RecvPid, LogFun,</span><br><span class="line">			     &lt;&lt;&quot;set names &#x27;&quot;, EncodingBinary/binary, &quot;&#x27;&quot;&gt;&gt;,</span><br><span class="line">			     Version)</span><br></pre></td></tr></table></figure></p>
<p>用来设定我们的编码方式，目前用的utf8.<br>下面了解下do_query的细节，因为之后我们要做的查询，插入等操作也经过它<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">do_query(Sock, RecvPid, LogFun, Query, Version) -&gt;</span><br><span class="line">    Query1 = iolist_to_binary(Query),</span><br><span class="line">    ?Log2(LogFun, debug, &quot;fetch ~p (id ~p)&quot;, [Query1,RecvPid]),</span><br><span class="line">    Packet =  &lt;&lt;?MYSQL_QUERY_OP, Query1/binary&gt;&gt;,</span><br><span class="line">    case do_send(Sock, Packet, 0, LogFun) of</span><br><span class="line">	ok -&gt;</span><br><span class="line">	    get_query_response(LogFun,RecvPid,</span><br><span class="line">				    Version);</span><br><span class="line">	&#123;error, Reason&#125; -&gt;</span><br><span class="line">	    Msg = io_lib:format(&quot;Failed sending data &quot;</span><br><span class="line">				&quot;on socket : ~p&quot;,</span><br><span class="line">				[Reason]),</span><br><span class="line">	    &#123;error, Msg&#125;</span><br><span class="line">    end.</span><br></pre></td></tr></table></figure></p>
<p>Query是我们的sql语句，比如上面的&lt;&lt;&lt;&quot;use aries_game&quot;&gt;&gt;,<br>Query1使我们给Query加上一个字节的3(?MYSQL_QUERY_OP是3）.<br>do_send将packet打包并发送，头三个字节是packet大小，第4个字节是序列号，之后是packet内容，如下<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">do_send(Sock, Packet, SeqNum, _LogFun) when is_binary(Packet), is_integer(SeqNum) -&gt;</span><br><span class="line">    Data = &lt;&lt;(size(Packet)):24/little, SeqNum:8, Packet/binary&gt;&gt;,</span><br><span class="line">    gen_tcp:send(Sock, Data).</span><br></pre></td></tr></table></figure></p>
<p>这时候向端口发送了请求,get_query_response等待回应。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">get_query_response(LogFun, RecvPid, Version) -&gt;</span><br><span class="line">    case do_recv(LogFun, RecvPid, undefined) of</span><br><span class="line">	&#123;ok, &lt;&lt;Fieldcount:8, Rest/binary&gt;&gt;, _&#125; -&gt;</span><br><span class="line">	    case Fieldcount of</span><br><span class="line">		0 -&gt;</span><br><span class="line">		    %% No Tabular data</span><br><span class="line">            &lt;&lt;AffectedRows:8, _Rest2/binary&gt;&gt; = Rest,</span><br><span class="line">            ?Log2(LogFun, debug, &quot;updated ~p&quot;, [AffectedRows]),</span><br><span class="line">		    &#123;updated, #mysql_result&#123;affectedrows=AffectedRows&#125;&#125;;</span><br><span class="line">		255 -&gt;</span><br><span class="line">		    &lt;&lt;_Code:16/little, Message/binary&gt;&gt;  = Rest,</span><br><span class="line">		    &#123;error, #mysql_result&#123;error=Message&#125;&#125;;</span><br><span class="line">		_ -&gt;</span><br><span class="line">		    %% Tabular data received</span><br><span class="line">		    case get_fields(LogFun, RecvPid, [], Version) of</span><br><span class="line">			&#123;ok, Fields&#125; -&gt;</span><br><span class="line">			    case get_rows(Fields, LogFun, RecvPid, []) of</span><br><span class="line">				&#123;ok, Rows&#125; -&gt;</span><br><span class="line">                    ?Log2(LogFun, debug, &quot;data: field:~p, rows:~p&quot;, [Fields, Rows]),</span><br><span class="line">                    &#123;data, #mysql_result&#123;fieldinfo=Fields,</span><br><span class="line">                            rows=Rows&#125;&#125;;</span><br><span class="line">				&#123;error, Reason&#125; -&gt;</span><br><span class="line">				    &#123;error, #mysql_result&#123;error=Reason&#125;&#125;</span><br><span class="line">			    end;</span><br><span class="line">			&#123;error, Reason&#125; -&gt;</span><br><span class="line">			    &#123;error, #mysql_result&#123;error=Reason&#125;&#125;</span><br><span class="line">		    end</span><br><span class="line">	    end;</span><br><span class="line">	&#123;error, Reason&#125; -&gt;</span><br><span class="line">	    &#123;error, #mysql_result&#123;error=Reason&#125;&#125;</span><br><span class="line">    end.</span><br></pre></td></tr></table></figure></p>
<p>第一句do_recv主要用来对第三个参数帧序列号的不同做匹配，这里是undefined，意在接受任何帧，如果指定一个帧号A，那么do_recv只接受A+1的消息。如下<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> do_recv(LogFun, RecvPid, SeqNum)  when is_function(LogFun);</span><br><span class="line">				       LogFun == undefined,</span><br><span class="line">				       SeqNum == undefined -&gt;</span><br><span class="line">    receive</span><br><span class="line">        &#123;mysql_recv, RecvPid, data, Packet, Num&#125; -&gt;</span><br><span class="line">	    &#123;ok, Packet, Num&#125;;</span><br><span class="line">	&#123;mysql_recv, RecvPid, closed, _E&#125; -&gt;</span><br><span class="line">	    &#123;error, &quot;mysql_recv: socket was closed&quot;&#125;</span><br><span class="line">    end;</span><br><span class="line">do_recv(LogFun, RecvPid, SeqNum) when is_function(LogFun);</span><br><span class="line">				      LogFun == undefined,</span><br><span class="line">				      is_integer(SeqNum) -&gt;</span><br><span class="line">    ResponseNum = SeqNum + 1,</span><br><span class="line">    receive</span><br><span class="line">        &#123;mysql_recv, RecvPid, data, Packet, ResponseNum&#125; -&gt;</span><br><span class="line">	    &#123;ok, Packet, ResponseNum&#125;;</span><br><span class="line">	&#123;mysql_recv, RecvPid, closed, _E&#125; -&gt;</span><br><span class="line">	    &#123;error, &quot;mysql_recv: socket was closed&quot;&#125;</span><br><span class="line">    end.</span><br></pre></td></tr></table></figure></p>
<p>这个函数将端口返回的Packet和帧序号返回，或者帧序号+1返回。<br>回到<code>case do_recv(LogFun, RecvPid, undefined) of</code><br>接下来是对结果的匹配，Fieldcount为0表示执行的是update操作，而不是请求某些数据。如果为255则表示出错，返回{error, #mysql_result{error = Message}}.<br>其他数值时，会执行get_field().<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">%% Support for MySQL 4.1.x and 5.x:</span><br><span class="line">get_fields(LogFun, RecvPid, Res, ?MYSQL_4_1) -&gt;</span><br><span class="line">    case do_recv(LogFun, RecvPid, undefined) of</span><br><span class="line">	&#123;ok, Packet, _Num&#125; -&gt;</span><br><span class="line">        ?Log2(LogFun, debug, &quot;get_field: packet ~p&quot;, [Packet]),</span><br><span class="line">	    case Packet of</span><br><span class="line">		&lt;&lt;254:8&gt;&gt; -&gt;</span><br><span class="line">		    &#123;ok, lists:reverse(Res)&#125;;</span><br><span class="line">		&lt;&lt;254:8, Rest/binary&gt;&gt; when size(Rest) &lt; 8 -&gt;</span><br><span class="line">		    &#123;ok, lists:reverse(Res)&#125;;</span><br><span class="line">		_ -&gt;</span><br><span class="line">		    &#123;_Catalog, Rest&#125; = get_with_length(Packet),</span><br><span class="line">		    &#123;_Database, Rest2&#125; = get_with_length(Rest),</span><br><span class="line">		    &#123;Table, Rest3&#125; = get_with_length(Rest2),</span><br><span class="line">		    %% OrgTable is the real table name if Table is an alias</span><br><span class="line">		    &#123;_OrgTable, Rest4&#125; = get_with_length(Rest3),</span><br><span class="line">		    &#123;Field, Rest5&#125; = get_with_length(Rest4),</span><br><span class="line">		    %% OrgField is the real field name if Field is an alias</span><br><span class="line">		    &#123;_OrgField, Rest6&#125; = get_with_length(Rest5),</span><br><span class="line"></span><br><span class="line">		    &lt;&lt;_Metadata:8/little, _Charset:16/little,</span><br><span class="line">		     Length:32/little, Type:8/little,</span><br><span class="line">		     _Flags:16/little, _Decimals:8/little,</span><br><span class="line">		     _Rest7/binary&gt;&gt; = Rest6,</span><br><span class="line">		    </span><br><span class="line">		    This = &#123;Table,</span><br><span class="line">			    Field,</span><br><span class="line">			    Length,</span><br><span class="line">			    get_field_datatype(Type)&#125;,</span><br><span class="line">		    get_fields(LogFun, RecvPid, [This | Res], ?MYSQL_4_1)</span><br><span class="line">	    end;</span><br><span class="line">	&#123;error, Reason&#125; -&gt;</span><br><span class="line">	    &#123;error, Reason&#125;</span><br><span class="line">    end.</span><br></pre></td></tr></table></figure></p>
<p>这里提供了两个版本的get_field,我的mysql是5.5所以会匹配到这个函数上。<br>get_field一开始仍然是do_recv，用来提取一个Packet。case Packet告诉我们这个包第一个字节是254的时候表示结果已经全部告诉我们了，这时候会将Res（result）翻转，返回。<br>get_with_length用来将Packet切割，用来得到Table， Field， Length等参数。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">get_with_length(&lt;&lt;251:8, Rest/binary&gt;&gt;) -&gt;</span><br><span class="line">    &#123;null, Rest&#125;;</span><br><span class="line">get_with_length(&lt;&lt;252:8, Length:16/little, Rest/binary&gt;&gt;) -&gt;</span><br><span class="line">    split_binary(Rest, Length);</span><br><span class="line">get_with_length(&lt;&lt;253:8, Length:24/little, Rest/binary&gt;&gt;) -&gt;</span><br><span class="line">    split_binary(Rest, Length);</span><br><span class="line">get_with_length(&lt;&lt;254:8, Length:64/little, Rest/binary&gt;&gt;) -&gt;</span><br><span class="line">    split_binary(Rest, Length);</span><br><span class="line">get_with_length(&lt;&lt;Length:8, Rest/binary&gt;&gt;) when Length &lt; 251 -&gt;</span><br><span class="line">    split_binary(Rest, Length).</span><br></pre></td></tr></table></figure></p>
<p>这个函数的意思大致可以看出来，如果第一个字节是251，就直接返回null和Rest，如果第一个字节小于251，那么第一个字节表示长度，将Rest分割成{Value， Rest2}，Value是我们需要的，对应长度的值，如果第一个字节大于251，分不同的情况，接下来的2个4个或者8个字节表示长度，将Rest分割。举个例子<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql:fetch(mysql_game_pool, &quot;select name from player where id = 301&quot;).</span><br><span class="line"></span><br><span class="line">=INFO REPORT==== 9-Jun-2015::16:43:29 ===</span><br><span class="line">I(&lt;0.94.0&gt;:mysql_conn:426) : fetch &lt;&lt;&quot;select name from player where id = 301&quot;&gt;&gt; (id &lt;0.95.0&gt;)</span><br><span class="line"></span><br><span class="line">=INFO REPORT==== 9-Jun-2015::16:43:29 ===</span><br><span class="line">I(&lt;0.94.0&gt;:mysql_conn:726) : get_field: packet &lt;&lt;3,100,101,102,10,97,114,105,</span><br><span class="line">                                                 101,115,95,103,97,109,101,6,</span><br><span class="line">                                                 112,108,97,121,101,114,6,112,</span><br><span class="line">                                                 108,97,121,101,114,4,110,97,</span><br><span class="line">                                                 109,101,4,110,97,109,101,12,</span><br><span class="line">                                                 33,0,150,0,0,0,253,5,64,0,0,0&gt;&gt;</span><br><span class="line"></span><br><span class="line">=INFO REPORT==== 9-Jun-2015::16:43:29 ===</span><br><span class="line">I(&lt;0.94.0&gt;:mysql_conn:726) : get_field: packet &lt;&lt;254,0,0,2,0&gt;&gt;</span><br><span class="line">&#123;data,&#123;mysql_result,[&#123;&lt;&lt;&quot;player&quot;&gt;&gt;,&lt;&lt;&quot;name&quot;&gt;&gt;,150,</span><br><span class="line">                      &#x27;VAR_STRING&#x27;&#125;],</span><br><span class="line">                    [[&lt;&lt;&quot;aaaa&quot;&gt;&gt;]],</span><br><span class="line">                    0,[]&#125;&#125;</span><br><span class="line"></span><br><span class="line">=INFO REPORT==== 9-Jun-2015::16:43:29 ===</span><br><span class="line">I(&lt;0.94.0&gt;:mysql_conn:770) : get_rows: packet &lt;&lt;4,97,97,97,97&gt;&gt;</span><br><span class="line"></span><br><span class="line">=INFO REPORT==== 9-Jun-2015::16:43:29 ===</span><br><span class="line">I(&lt;0.94.0&gt;:mysql_conn:770) : get_rows: packet &lt;&lt;254,0,0,2,0&gt;&gt;</span><br><span class="line">(aries_game@192.168.1.85)2&gt; </span><br><span class="line">=INFO REPORT==== 9-Jun-2015::16:43:29 ===</span><br><span class="line">I(&lt;0.94.0&gt;:mysql_conn:667) : data: field:[&#123;&lt;&lt;&quot;player&quot;&gt;&gt;,&lt;&lt;&quot;name&quot;&gt;&gt;,150,</span><br><span class="line">                                           &#x27;VAR_STRING&#x27;&#125;], rows:[[&lt;&lt;&quot;aaaa&quot;&gt;&gt;]]</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>我们执行了一个sql语句，从player表中选出id为301的玩家的名字。<br>端口回复给我们的是get_field后面打印的二进制串。</p>
<ol>
<li>第一个字节是3，不是254。走get_with_length拆分。</li>
<li>将100,101,102提出，为CataLog,这个参数我们不需要。</li>
<li>10表示接下来取10个字节，一直到109，101.位Database，我们也不需要</li>
<li>接下来6，表示6个字节，&lt;&lt;112,108,97,121,101,114&gt;&gt;提取为Table，也就是我们的表名，我们在shell中打一下可以看到实际上就是&lt;&lt;&quot;player&quot;&gt;&gt;。表示我们是从player表取得。</li>
<li>接下来6个字节和上面一下，我们不需要。</li>
<li>下面4个字节&lt;&lt;110,97,109,101&gt;&gt;,就是&lt;&lt;&quot;name&quot;&gt;&gt;,表示字段名。</li>
<li>后面4个字节以上面一下，不需要。</li>
<li>从12开始一直到最后我们只需要&lt;&lt;150,0,0,0&gt;&gt;这四个表示长度,注意是小段存储，即长150，253，表示Type.</li>
<li>紧着着第一个packet到达，由于是254，告诉我们这个语句结果已返回。<br>这个时候我们只知道是player表的name字段，接下来get_rows将得到具体结果。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">get_rows(Fields, LogFun, RecvPid, Res) -&gt;</span><br><span class="line">    case do_recv(LogFun, RecvPid, undefined) of</span><br><span class="line">	&#123;ok, Packet, _Num&#125; -&gt;</span><br><span class="line">        ?Log2(LogFun, debug, &quot;get_rows: packet ~p&quot;, [Packet]),</span><br><span class="line">	    case Packet of</span><br><span class="line">		&lt;&lt;254:8, Rest/binary&gt;&gt; when size(Rest) &lt; 8 -&gt;</span><br><span class="line">		    &#123;ok, lists:reverse(Res)&#125;;</span><br><span class="line">		_ -&gt;</span><br><span class="line">		    &#123;ok, This&#125; = get_row(Fields, Packet, []),</span><br><span class="line">		    get_rows(Fields, LogFun, RecvPid, [This | Res])</span><br><span class="line">	    end;</span><br><span class="line">	&#123;error, Reason&#125; -&gt;</span><br><span class="line">	    &#123;error, Reason&#125;</span><br><span class="line">    end.</span><br><span class="line"></span><br><span class="line">%% part of get_rows/4</span><br><span class="line">get_row([], _Data, Res) -&gt;</span><br><span class="line">    &#123;ok, lists:reverse(Res)&#125;;</span><br><span class="line">get_row([Field | OtherFields], Data, Res) -&gt;</span><br><span class="line">    &#123;Col, Rest&#125; = get_with_length(Data),</span><br><span class="line">    This = case Col of</span><br><span class="line">	       null -&gt;</span><br><span class="line">		   undefined;</span><br><span class="line">	       _ -&gt;</span><br><span class="line">		   convert_type(Col, element(4, Field))</span><br><span class="line">	   end,</span><br><span class="line">    get_row(OtherFields, Rest, [This | Res]).</span><br></pre></td></tr></table></figure>
其中Field为[{&lt;&lt;&quot;player&quot;&gt;&gt;,&lt;&lt;&quot;name&quot;&gt;&gt;,150,&#39;VAR_STRING&#39;}],<br>与上面get_field大致相同，row的这个packet很简单，&lt;&lt;4,97,97,97,97&gt;&gt;，后面的4个字节就是我们要的结果就是&lt;&lt;&quot;aaaa&quot;&gt;&gt;.然后convert_type将结果转为对应的形式<br>convert_type不贴了，ｈｅｘｏ转码会有问题．<br>我们的类型是VAR_STRING，直接原样返回。<br>这样回到get_query_response，我们得到了需要的结果{data, #mysql_result{}}这种形式。<br>在往上回到init处，我们执行完&lt;&lt;&quot;use XXX(数据库名)&quot;&gt;&gt;, 返回成功后，执行&lt;&lt;&quot;set names utf8&quot;&gt;&gt;,<br>最后构造State<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">State = #state&#123;mysql_version=Version,</span><br><span class="line">					   recv_pid = RecvPid,</span><br><span class="line">					   socket   = Sock,</span><br><span class="line">					   log_fun  = LogFun,</span><br><span class="line">					   pool_id  = PoolId,</span><br><span class="line">					   data     = &lt;&lt;&gt;&gt;</span><br><span class="line">					  &#125;,</span><br><span class="line">			    loop(State)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>并开始loop。至此这个mysql_conn进程创建完毕。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/06/10/erlang_mysql_driver%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          erlang_mysql_driver源码分析(三)
        
      </div>
    </a>
  
  
    <a href="/2015/06/08/erlang_mysql_driver/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">erlang_mysql_driver 源码分析(一)</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="erlang_mysql_driver源码分析(二)" data-title="erlang_mysql_driver　源码分析(二)" data-url="http://youthy.github.io/2015/06/09/erlang_mysql_driver%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%8C)/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2021 youthy
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>


<script src="/js/main.js"></script>







<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>